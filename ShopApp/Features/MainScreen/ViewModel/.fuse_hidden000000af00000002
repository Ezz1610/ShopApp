//
//  HomeViewModel.swift
//  ShopApp
//
//  Created by Mohammed Hassanien on 23/10/2025.
//
// MARK: - HomeViewModel.swift
import Foundation
import SwiftUI

@MainActor
final class HomeViewModel: ObservableObject {
    // MARK: - Published Properties
    @Published var brands: [SmartCollection] = []                 // all collections / brands
    @Published var vendorProducts: [ProductModel] = []           // products for vendor
    @Published var collectionProducts: [ProductModel] = []       // products for selected collection
    @Published var allProducts: [ProductModel] = []              // all products for search
    @Published var searchText: String = ""                       // search keyword
    @Published var isLoading = false
    @Published var errorMessage: String?

    private let api: ApiServices

    init(api: ApiServices = ApiServices()) {
        self.api = api
    }

    // MARK: - Load Brands / Collections
    func loadBrands() async {
        guard !isLoading else { return }
        isLoading = true
        errorMessage = nil
        defer { isLoading = false }

        do {
            let fetchedBrands = try await api.fetchSmartCollections()
            brands = fetchedBrands
        } catch {
            errorMessage = error.localizedDescription
            brands = []
        }
    }

    @MainActor
    func loadProducts(forVendor vendor: String) async -> [ProductModel] {
        isLoading = true
        defer { isLoading = false }
        do {
            let products = try await api.fetchProducts(byVendor: vendor)
            vendorProducts = products
            print("✅ Loaded all products \(vendor) for search")
            print("✅ Loaded all products \(vendorProducts.count) for search")

            return products // لا نكتب في vendorProducts
        } catch {
            errorMessage = error.localizedDescription
            return []
        }
    }



    // MARK: - Load All Products (for search)
    func loadAllProducts(limit: Int = 250) async {
        isLoading = true
        errorMessage = nil
        defer { isLoading = false }

        do {
            let products = try await api.fetchAllProducts(limit: limit)
            allProducts = products
            print("✅ Loaded all products (\(products.count)) for search")
        } catch {
            errorMessage = "Failed to load all products: \(error.localizedDescription)"
            allProducts = []
        }
    }

    // MARK: - Load Products for a Selected Collection
    func loadProducts(forCollection collectionID: Int) async {
        isLoading = true
        errorMessage = nil
        collectionProducts = []
        defer { isLoading = false }

        do {
            let products = try await api.fetchProductsByCollectionID(collectionID)
            collectionProducts = products
            print("✅ Loaded \(products.count) products for collection \(collectionID)")
        } catch {
            errorMessage = "Failed to load products for collection \(collectionID): \(error.localizedDescription)"
            collectionProducts = []
        }
    }

    // MARK: - Search Filter
    var filteredProducts: [ProductModel] {
        guard !searchText.isEmpty else { return [] }
        return allProducts.filter {
            $0.title.localizedCaseInsensitiveContains(searchText) ||
            $0.vendor.localizedCaseInsensitiveContains(searchText) ||
            $0.tags.localizedCaseInsensitiveContains(searchText)
        }
    }
}
